services:
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: perpustakaan-rabbitmq
    ports:
      - "5672:5672"      # AMQP port
      - "15672:15672"    # Management UI
    networks:
      - perpustakaan-network
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  eureka-server:
    build:
      context: ./eureka
      dockerfile: dockerfile
    container_name: perpustakaan-eureka
    ports:
      - "10761:8761"
    networks:
      - perpustakaan-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  api-gateway:
    build:
      context: ./api-get-away
      dockerfile: dockerfile
    container_name: perpustakaan-api-gateway
    ports:
      - "10080:8080"
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - perpustakaan-network
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/

  anggota-service:
    build:
      context: ./anggota
      dockerfile: dockerfile
    container_name: perpustakaan-anggota
    ports:
      - "10081:8081"
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - perpustakaan-network
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/

  buku-service:
    build:
      context: ./buku
      dockerfile: dockerfile
    container_name: perpustakaan-buku
    ports:
      - "10082:8082"
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - perpustakaan-network
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/

  peminjaman-service:
    build:
      context: ./peminjaman
      dockerfile: dockerfile
    container_name: perpustakaan-peminjaman
    ports:
      - "10083:8084"
    depends_on:
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - perpustakaan-network
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest

  pengembalian-service:
    build:
      context: ./pengembalian
      dockerfile: dockerfile
    container_name: perpustakaan-pengembalian
    ports:
      - "10084:8085"
    depends_on:
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - perpustakaan-network
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest

  command-service:
    build:
      context: ./command-service
      dockerfile: dockerfile
    container_name: perpustakaan-command
    ports:
      - "10085:8088"
    depends_on:
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - perpustakaan-network
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest

  query-service:
    build:
      context: ./query-service
      dockerfile: dockerfile
    container_name: perpustakaan-query
    ports:
      - "10086:8087"
    depends_on:
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - perpustakaan-network
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest

  rabbitmq-peminjaman:
    build:
      context: ./rabbitmq-peminjaman-service
      dockerfile: dockerfile
    container_name: perpustakaan-rabbitmq-peminjaman
    ports:
      - "10087:8086"
    depends_on:
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - perpustakaan-network
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest

  rabbitmq-pengembalian:
    build:
      context: ./rabbit_pengembalian
      dockerfile: dockerfile
    container_name: perpustakaan-rabbitmq-pengembalian
    ports:
      - "10088:8089"
    depends_on:
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - perpustakaan-network
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest

networks:
  perpustakaan-network:
    driver: bridge

volumes:
  rabbitmq_data:
    driver: local
